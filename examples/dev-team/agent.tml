trident: "0.1"
name: dev-team
description: Self-improving development team for Trident
version: "0.7.0"

defaults:
  model: anthropic/claude-sonnet-4-20250514
  temperature: 0.3
  max_tokens: 8192

entrypoints:
  - input

nodes:
  input:
    type: input
    schema:
      feature_request:
        type: string
        description: The feature request or bug to implement

  output:
    type: output
    format: json

edges:
  # Phase 1: Understand the codebase structure
  e1:
    from: input
    to: list_structure

  # Phase 2: Extract search context from feature request
  e2:
    from: input
    to: extract_context
    mapping:
      feature_request: feature_request

  e3:
    from: list_structure
    to: extract_context
    mapping:
      project_files: files

  # Phase 3: Search codebase with extracted terms
  e4:
    from: extract_context
    to: search_codebase
    mapping:
      terms: search_terms

  # Phase 4: Read likely affected files
  e5:
    from: extract_context
    to: read_context_files
    mapping:
      files: likely_files

  # Phase 5: Clarify requirements with full context
  e6:
    from: input
    to: clarify
    mapping:
      feature_request: feature_request

  e7:
    from: search_codebase
    to: clarify
    mapping:
      codebase_context: matches

  e8:
    from: read_context_files
    to: clarify
    mapping:
      file_contents: content

  # Phase 6: Design with existing code
  e9:
    from: clarify
    to: read_affected_files
    mapping:
      files: files_likely_affected

  e10:
    from: clarify
    to: design
    mapping:
      title: title
      problem: problem
      requirements: requirements
      files_likely_affected: files_likely_affected

  e11:
    from: read_affected_files
    to: design
    mapping:
      existing_code: content

  # Phase 7: Implement with file context
  e12:
    from: design
    to: read_for_implement
    mapping:
      files: modified_files

  e13:
    from: clarify
    to: implement
    mapping:
      title: title

  e14:
    from: design
    to: implement
    mapping:
      approach: approach
      changes: changes

  e15:
    from: read_for_implement
    to: implement
    mapping:
      file_contents: content

  # Phase 8: Code Review
  e16:
    from: clarify
    to: code_review
    mapping:
      title: title

  e17:
    from: design
    to: code_review
    mapping:
      approach: approach
      changes: changes

  e18:
    from: implement
    to: code_review
    mapping:
      code_changes: patches

  e19:
    from: read_for_implement
    to: code_review
    mapping:
      original_file_contents: content

  # Phase 9: Validate in sandbox BEFORE applying
  e20:
    from: code_review
    to: validate_patches
    mapping:
      patches: revised_patches

  # Phase 10: Validation gate (pure function) decides whether to proceed
  e21:
    from: code_review
    to: validation_gate
    mapping:
      patches: revised_patches
      review_approved: approved
      review_severity: severity

  e22:
    from: validate_patches
    to: validation_gate
    mapping:
      validation_result: .

  # Phase 11: Apply patches only if validation passed
  e23:
    from: validation_gate
    to: apply_patches
    condition: proceed == true
    mapping:
      patches: patches_to_apply

  # Phase 12: Run final lint on applied changes (for any auto-fixes)
  e24:
    from: apply_patches
    to: run_lint

  # Output: Success path (validation passed, patches applied)
  e25:
    from: validation_gate
    to: output
    condition: proceed == true
    mapping:
      status: status
      summary: summary

  e26:
    from: apply_patches
    to: output
    mapping:
      files_patched: files_patched

  e27:
    from: run_lint
    to: output
    mapping:
      lint_fixed: fixed

  # Output: Failure path (validation failed, no patches applied)
  e28:
    from: validation_gate
    to: output
    condition: proceed == false
    mapping:
      status: status
      summary: summary
      errors: errors
      lint_output: lint_output
      typecheck_output: typecheck_output
      test_output: test_output

tools:
  list_structure:
    type: python
    module: file_ops
    function: list_project_structure
    description: List all files in the project

  search_codebase:
    type: python
    module: file_ops
    function: search_multiple
    description: Search codebase for multiple terms

  read_context_files:
    type: python
    module: file_ops
    function: read_files_multi
    description: Read files identified as relevant

  read_affected_files:
    type: python
    module: file_ops
    function: read_files_multi
    description: Read files likely to be affected

  read_for_implement:
    type: python
    module: file_ops
    function: read_files_multi
    description: Read files for implementation

  validate_patches:
    type: python
    module: file_ops
    function: validate_patches
    description: Validate patches in a sandbox (lint, typecheck, tests) without modifying workspace

  validation_gate:
    type: python
    module: file_ops
    function: validation_gate
    description: Deterministic gate that decides whether to apply patches based on validation results

  apply_patches:
    type: python
    module: file_ops
    function: apply_patches
    description: Apply unified diff patches to files (only called after validation passes)

  run_lint:
    type: python
    module: file_ops
    function: run_lint
    description: Run ruff linter and formatter with auto-fix

env:
  ANTHROPIC_API_KEY:
    description: Anthropic API key for Claude
    required: true
  TRIDENT_WORKSPACE:
    description: Path to the workspace (codebase root)
    required: true
